## 特别重要：呼叫组件在1.6.0版本后，做了接口以及接入方式的更新，请移步[官网查看](https://doc.yunxin.163.com/nertccallkit/docs/jk1NDQ2MTA?platform=web)。

<br />

## 以下内容只用作对现有老用户1.6.0版本之前的版本的参考进行保留。

## 话单说明

<img src="../../../images/image-20210929192637093.png" width="20%" />

如上图，话单为进行通话呼叫时发送的一条消息，标记此次呼叫的状态；上图分别对应**主叫取消话单**、**被叫拒绝话单**、**超时未接听话单**、**被叫占线话单**、**正常通话带有时长的话单**。

## 话单发送

若用户参考[快速开始](../../../快速开始/跑通示例项目_Web.md)完成话单功能相关权限开通，则组件将话单消息通知到用户。

话单消息共有5类，其中4类为未接通时的话单，如拒接话单、占线话单、超时未接听话单、主叫取消话单，此类话单均由主叫方客户端发送；1类为带有通话时长的正常话单，此类话单为服务端直接发送。话单结构见话单解析部分。

## 话单接收及解析
- 在发送端，可以通过 `onMessageSent` 事件监听到发送话单的通知，然后通过`IM实例`的`getLocalMsgs`方法获取到历史消息，从而更新话单的UI
- 在接收端，可以给组件的`login`方法传入`onmsg`回调，获取到 type 为 `g2` 的消息，从而更新话单的UI

### 话单类型及结构体

| 代码                                    | 话单类型 | 说明                                                         |
| --------------------------------------- | -------- | ------------------------------------------------------------ |
| `status` | 1        | 正常通话话单，通话双方都进入音视频通话后进行挂断。由组件服务器发送。 |
| `status` | 2        | 主叫取消话单，主叫呼叫后主动取消的话单。由客户端主叫方发送。 |
| `status` | 3        | 被叫拒接话单，被叫拒接接听后的话单。客户端主叫方收到被叫拒接消息后进行发送。 |
| `status`  | 4        | 超时话单，被叫收到通话邀请后不操作等待超时产生的话单。客户端主叫方发送。 |
| `status`     | 5        | 占线话单（用户忙），当主叫呼叫被叫时，被叫仍处于通话以及呼叫/被叫中，此时被叫会拒绝主叫的通话邀请。客户端主叫收到消息后会发送占线话单。 |

```json
// 收到的话单的json结构
{
   "type": 1,                       //1 表示音频，2 表示视频
   "channelId": 123,                //G2的channelId
   "status": 1,                     //1 表示正常结束通话话单，对应上表的话单类型
   "durations": [
           {
               "accid":"acc01",
               "duration":10
           },
           {
               "accid":"acc02",
               "duration":12
           }
   ]
}
```

## 实现自己的话单

若组件自带的话单功能不能满足需求，可以参考如下步骤实现自己的话单；

1. 关闭组件自带话单功能；

   1. 进入云信控制后台 - 音视频2.0 - 话单配置 - 关闭；

2. 在云信后台开通对应抄送；

   1. 进入云信控制后台 - 消息抄送配置 - 音视频通话2.0相关抄送 - 房间时长消息抄送（eventType=8）

3. 确定话单协议，如用 json 表示

   ```json
   {
     "type": 1   // 话单类型
     "data": ... // 话单消息内容，如通话时长等信息
   }
   ```

4. 参考[发送自定义消息](https://doc.yunxin.163.com/docs/TM5MzM5Njk/jg0NTA4NjE?platformId=60179#%E5%8F%91%E9%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B6%88%E6%81%AF)，将步骤3确定的话单协议作为自定义内容进行发送与解析；至此，已经完成自定义话单消息的发送以及解析，但是何时发送什么消息可接着跟着步骤实现；

5. 组件支持的话单种类如上文共有5类，分别为**主叫取消话单**、**被叫拒绝话单**、**超时未接听话单**、**被叫占线话单**、**正常通话带有时长的话单**。其中**主叫取消话单**、**被叫拒绝话单**、**超时未接听话单**、**被叫占线话单**都由主叫方统一发送。主叫取消话单可在主叫调用`cancel`方法成功后发送，在收到 `onUserReject`回调发送被叫拒绝话单，在收到 `onCallingTimeOut`回调发送超时未接听话单，在收到 `onUserBusy`回调发送被叫占线话单。正常通话带有时长的话单建议由服务端发送，用户服务器收到云信服务器的抄送（房间时长消息抄送（eventType=8））根据抄送发送时长话单。

